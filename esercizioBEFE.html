<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Contatti</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<style>
    nav li {
        display: inline-block;
        margin-right: 10px;
    }

    #formDiv {
        margin: 10px;
        padding: 15px;
        background-color: whitesmoke;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: none;
    }

    #elenco {
        margin: 10px;
        padding: 15px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    #elenco table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    #elenco th, #elenco td {
        border: 1px solid #ccc;
        padding: 8px;
    }

    #elenco th {
        background-color: #e9ecef;
    }

    #aggiungiForm label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }
    #aggiungiForm input.form-control {
        width: calc(100% - 90px);
        display: inline-block;
        margin-right: 5px;
    }
    #aggiungiForm button.btn-danger.btn-sm {
        vertical-align: bottom;
    }


    #ricerca label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }
    #ricerca input {
        display: inline-block;
        margin-right: 5px;
    }
    #ricerca{
        border: 1px solid #ccc;
        background-color: whitesmoke;
        padding: 10px;
        border-radius: 10px;
    }

</style>
<body>
<header>
    <nav class="navbar navbar-light bg-light p-3">
        <ul class="navbar-nav d-flex flex-row">
            <li class="nav-item">
                <button class="btn btn-primary me-2" id="button_Form" onclick="nascondi()">Nuovo Contatto</button>
            </li>
            <li class="nav-item">
                <button class="btn btn-danger" id="mostraElencoBtn" onclick="mostraElenco()">Mostra Elenco</button>
            </li>
            <li class="nav-item">
                <button class="btn btn-warning" id="ricercaBtn" onclick="ricerca()">Ricerca contatto</button>
            </li>
        </ul>
    </nav>
</header>

<main class="container mt-4">
    <div id="formDiv">
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addfieldModal" id="addfieldbutton">Aggiungi Campo Dinamico</button>
        <hr>
    </div>

    <div id="elenco" style="display: block;"> <h2>Elenco Contatti</h2>
        <table class="table table-striped table-bordered">
            <thead id="elencoTableHeader">
                </thead>
            <tbody id="elencoTableBody">
                </tbody>
        </table>
        <button class="btn btn-danger mt-3" id="deleteAllBtn" onclick="deleteAll()">Elimina tutti</button>
    </div>

    <div id="ricerca"> </div>

    <div id="risultatoRicerca"></div>

    <div class="modal fade" tabindex="-1" id="addfieldModal" aria-labelledby="addfieldModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addfieldModalLabel">Aggiungi Nuovo Campo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="tipo_campo" class="form-label">Tipo di Campo</label>
                        <select class="form-select" id="tipo_campo" name="tipo_campo" required>
                            <option value="" selected>Scegli</option>
                            <option value="text">Testo</option>
                            <option value="number">Numero</option>
                            <option value="email">E-Mail</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="nome_campo" class="form-label">Nome del Campo (tutto attaccato e minuscolo)</label>
                        <input type="text" class="form-control" id="nome_campo" name="nome_campo" placeholder="es. nomeutente" required/>
                    </div>

                    <div class="mb-3">
                        <label for="testo_label" class="form-label">Testo dell'etichetta (visualizzato sul form)</label>
                        <input type="text" class="form-control" id="testo_label" name="testo_label" placeholder="es. Nome Utente"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-primary" id="savenewfield">Salva Campo</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    // URL base del tuo backend Spring Boot
    const BASE_URL = "http://localhost:8080/rubrica"; // Assicurati che questa sia la tua URL corretta

    // I campi "standard" che il backend si aspetta.
    // Gli altri campi dinamici aggiunti tramite il modal non verranno inviati al backend
    // a meno che tu non modifichi anche il tuo model Utente e il controller lato Java.
    let campi = [
        { label: "Nome", nome_campo: "nome", tipo: "text" },
        { label: "Cognome", nome_campo: "cognome", tipo: "text" },
        { label: "Email", nome_campo: "email", tipo: "email" },
        { label: "Telefono", nome_campo: "telefono", tipo: "text" }, // Modificato da 'cellulare'
        { label: "Età", nome_campo: "eta", tipo: "number" } // Modificato da 'anni'
    ];

    let persone = [];

    // Funzione per renderizzare il form dinamico
    function renderForm(data = {}) { // Aggiunto un parametro 'data' per pre-popolare il form in modifica
        let formDiv = document.getElementById("formDiv");
        let existingForm = formDiv.querySelector("form"); // Seleziona il form esistente se presente 
        if (existingForm) {
            existingForm.remove(); // Rimuovi il form precedente se presente 
        }

        const form = document.createElement("form");
        form.id = "aggiungiForm";
        formDiv.appendChild(form);

        const hiddenId = document.createElement("input"); // Usiamo 'id' per la modifica
        hiddenId.type = "hidden";
        hiddenId.id = "utenteId"; // ID per l'utente, non un semplice indice
        hiddenId.value = data.id || ""; // Popola con l'ID se presente
        form.appendChild(hiddenId);

        campi.forEach((campo, index) => {
            const fieldContainer = document.createElement("div");
            fieldContainer.classList.add("mb-3");

            const label = document.createElement("label");
            label.textContent = campo.label || campo.nome_campo.charAt(0).toUpperCase() + campo.nome_campo.slice(1);
            label.htmlFor = campo.nome_campo;
            fieldContainer.appendChild(label);

            const input = document.createElement("input");
            input.type = campo.tipo;
            input.name = campo.nome_campo;
            input.id = campo.nome_campo;
            input.required = true;
            input.classList.add("form-control");
            // Popola l'input con i dati se disponibili
            input.value = data[campo.nome_campo] !== undefined ? data[campo.nome_campo] : '';
            fieldContainer.appendChild(input);

            // Per i campi dinamici aggiunti dal modal, permettiamo la rimozione
            // I campi 'standard' (nome, cognome, email, telefono, eta) non dovrebbero essere rimovibili
            if (!['nome', 'cognome', 'email', 'telefono', 'eta'].includes(campo.nome_campo)) {
                const removeButton = document.createElement("button");
                removeButton.textContent = "Rimuovi";
                removeButton.type = "button";
                removeButton.classList.add("btn", "btn-danger", "btn-sm", "ms-2");
                removeButton.setAttribute('data-field-name', campo.nome_campo); // Usa il nome del campo per la rimozione
                removeButton.onclick = (event) => {
                    const fieldToRemoveName = event.target.getAttribute('data-field-name');
                    if (confirm(`Sei sicuro di voler rimuovere il campo '${campo.label}'?`)) {
                        campi = campi.filter(c => c.nome_campo !== fieldToRemoveName);
                        renderForm(data); // Rerenderizza il form mantenendo i dati attuali
                    }
                }
                fieldContainer.appendChild(removeButton);
            }
            form.appendChild(fieldContainer);
        });

        const submitButton = document.createElement("button");
        submitButton.textContent = "Salva";
        submitButton.type = "button";
        submitButton.classList.add("btn", "btn-success", "mt-3", "me-2");
        form.appendChild(submitButton);

        const annullaButton = document.createElement("button");
        annullaButton.textContent = "Annulla";
        annullaButton.type = "button";
        annullaButton.classList.add("btn", "btn-secondary", "mt-3");
        form.appendChild(annullaButton);

        submitButton.onclick = async (e) => { // Reso async
            e.preventDefault();
            await save(); // Chiama la funzione save() al click
        }

        annullaButton.onclick = (e) => {
            e.preventDefault();
            mostraElenco();
        }
    }
    renderForm(); // Chiama renderForm per creare il form all'avvio

    // Funzione per salvare i dati del form (Aggiungi/Modifica)
    let save = async () => {
        const formElement = document.getElementById("aggiungiForm");

        if (!formElement.checkValidity()) {
            formElement.reportValidity();
            alert("Compila tutti i campi obbligatori!");
            return;
        }

        let utenteData = {};
        const utenteId = document.getElementById("utenteId").value;

        // Raccogliamo solo i campi che il backend si aspetta
        // Nome, Cognome, Email, Telefono, Eta
        const campiPerBackend = ['nome', 'cognome', 'email', 'telefono', 'eta'];

        campiPerBackend.forEach(nomeCampo => {
            const input = formElement.querySelector(`#${nomeCampo}`);
            if (input) {
                utenteData[nomeCampo] = (input.type === 'number' || nomeCampo === 'eta') ? parseInt(input.value, 10) : input.value;
            }
        });

        console.log("Dati da inviare al backend:", utenteData);

        let url;
        let method;
        let successMessage;

        if (utenteId) { // Se abbiamo un ID, è una modifica (PUT)
            url = `${BASE_URL}/edit/${utenteId}?id=${utenteId}&nome=${utenteData.nome}&cognome=${utenteData.cognome}&email=${utenteData.email}&telefono=${utenteData.telefono}&eta=${utenteData.eta}`;
            method = 'PUT';
            successMessage = "Contatto modificato con successo!";
        } else { // Altrimenti è una nuova aggiunta (POST)
            url = `${BASE_URL}/aggiungi?nome=${utenteData.nome}&cognome=${utenteData.cognome}&email=${utenteData.email}&telefono=${utenteData.telefono}&eta=${utenteData.eta}`;
            method = 'POST';
            successMessage = "Contatto aggiunto con successo!";
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json' // con json funziona per tutti i metodi POST e PUT del backend 
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Errore HTTP! Status: ${response.status}, Messaggio: ${errorText}`);
            }

            const savedUtente = await response.json(); // Il backend restituisce l'utente salvato
            console.log("Risposta dal backend:", savedUtente);
            alert(successMessage);

            formElement.reset();
            document.getElementById("utenteId").value = ""; // Resetta l'ID
            nascondi();
            await mostraElenco(); // Ricarica l'elenco dopo il salvataggio
        } catch (error) {
            console.error("Errore durante il salvataggio:", error);
            alert("Si è verificato un errore durante il salvataggio del contatto: " + error.message);
        }
    }

    // Funzione per aggiungere un nuovo campo dinamico tramite il modal
    function addField() {
        const tipo_campo = document.getElementById("tipo_campo").value;
        const nome_campo = document.getElementById("nome_campo").value;
        const testo_label = document.getElementById("testo_label").value;

        if (!tipo_campo || tipo_campo === "Scegli" || !nome_campo) {
            alert("Tipo e nome del campo sono obbligatori.");
            return;
        }

        if (campi.some(campo => campo.nome_campo === nome_campo)) {
            alert(`Esiste già un campo con il nome '${nome_campo}'. Scegli un nome diverso.`);
            return;
        }

        const campo = {
            tipo: tipo_campo,
            nome_campo: nome_campo,
            label: testo_label || nome_campo.charAt(0).toUpperCase() + nome_campo.slice(1)
        }
        campi.push(campo);
        renderForm(); // Rerenderizza il form per includere il nuovo campo

        document.getElementById("tipo_campo").value = "";
        document.getElementById("nome_campo").value = "";
        document.getElementById("testo_label").value = "";
        const addFieldModal = bootstrap.Modal.getInstance(document.getElementById('addfieldModal'));
        if (addFieldModal) {
            addFieldModal.hide();
        }
    }

    document.getElementById("savenewfield").addEventListener("click", addField);


    // Funzione per nascondere/mostrare le sezioni
    function nascondi() {
        let formDiv = document.getElementById("formDiv");
        let elencoDiv = document.getElementById("elenco");
        let ricercaDiv = document.getElementById("ricerca");
        let risultatoRicercaDiv= document.getElementById("risultatoRicerca");

        if (formDiv.style.display === "none") {
            formDiv.style.display = "block";
            elencoDiv.style.display = "none";
            ricercaDiv.style.display = "none";
            risultatoRicercaDiv.style.display = "none";

            // Quando mostri il form per un nuovo contatto, pulisci l'ID e resetta il form
            document.getElementById("utenteId").value = "";
            document.getElementById("aggiungiForm").reset();
        } else {
            formDiv.style.display = "none";
            elencoDiv.style.display = "block";
        }
    }

    // Funzione per la ricerca di contatti
    function ricerca() {
        const formDiv = document.getElementById("formDiv");
        const elencoDiv = document.getElementById("elenco");
        const ricercaDiv = document.getElementById("ricerca");
        const risultatoRicercaDiv = document.getElementById("risultatoRicerca");

        formDiv.style.display = "none";
        elencoDiv.style.display = "none";
        risultatoRicercaDiv.style.display = "none";
        ricercaDiv.style.display = "block";
        ricercaDiv.innerHTML = "";

        const titolo = document.createElement("h2");
        titolo.textContent = "Ricerca contatto";
        ricercaDiv.appendChild(titolo);
        ricercaDiv.appendChild(document.createElement("hr"));

        const form = document.createElement("form");

        const labelN = document.createElement("label");
        labelN.textContent = "Nome";
        form.appendChild(labelN);
        const inputNome = document.createElement("input");
        inputNome.id = "inputNomeRicerca"; // ID univoco per la ricerca
        inputNome.classList.add("form-control", "mb-2");
        form.appendChild(inputNome);

        const labelC = document.createElement("label");
        labelC.textContent = "Cognome";
        form.appendChild(labelC);
        const inputCognome = document.createElement("input");
        inputCognome.id = "inputCognomeRicerca"; // ID univoco per la ricerca
        inputCognome.classList.add("form-control", "mb-2");
        form.appendChild(inputCognome);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "Cerca";
        btn.classList.add("btn", "btn-primary", "mt-2");
        btn.onclick = async () => { // Reso async
            const nomeRicerca = document.getElementById("inputNomeRicerca").value;
            const cognomeRicerca = document.getElementById("inputCognomeRicerca").value;
            
            try {
                const response = await fetch(`${BASE_URL}/getAll?nome=${nomeRicerca}&cognome=${cognomeRicerca}`);
                if (!response.ok) {
                    throw new Error(`Errore HTTP! Status: ${response.status}`);
                }
                const risultati = await response.json();
                mostraRisultatiRicerca(risultati);
            } catch (error) {
                console.error("Errore durante la ricerca:", error);
                alert("Si è verificato un errore durante la ricerca: " + error.message);
            }
        };

        form.appendChild(btn);
        ricercaDiv.appendChild(form);
    }

    // Funzione per mostrare l'elenco dei contatti nella tabella (fetch dal backend)
    async function mostraElenco() {
        let formDiv = document.getElementById("formDiv");
        let elencoDiv = document.getElementById("elenco");
        let ricercaDiv = document.getElementById("ricerca");
        let risultatoRicercaDiv = document.getElementById("risultatoRicerca");

        formDiv.style.display = "none";
        elencoDiv.style.display = "block";
        ricercaDiv.style.display = "none";
        risultatoRicercaDiv.style.display = "none";

        const tableHeader = document.getElementById("elencoTableHeader");
        const tableBody = document.getElementById("elencoTableBody");

        tableHeader.innerHTML = '';
        tableBody.innerHTML = '';

        try {
            // Chiamata GET per ottenere tutti gli utenti dal backend
            // Nota: il tuo getAll richiede nome e cognome. Se vuoi un "get all" generico,
            // il backend dovrebbe avere un endpoint senza RequestParam.
            // Per ora, userò stringhe vuote per nome e cognome per fargli restituire tutto.
            const response = await fetch(`${BASE_URL}/getAll?nome=&cognome=`);
            if (!response.ok) {
                throw new Error(`Errore HTTP! Status: ${response.status}`);
            }
            persone = await response.json(); // Aggiorna l'array 'persone' con i dati dal backend

            if (persone.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${campi.length + 2}">Nessun contatto salvato.</td></tr>`; // +2 per ID e Azioni
                return;
            }

            // Aggiungi una colonna ID per la visualizzazione
            const headerRow = document.createElement("tr");
            let thId = document.createElement("th");
            thId.textContent = "ID";
            headerRow.appendChild(thId);

            campi.forEach(campo => {
                const th = document.createElement("th");
                th.textContent = campo.label;
                headerRow.appendChild(th);
            });
            const thActions = document.createElement("th");
            thActions.textContent = "Azioni";
            headerRow.appendChild(thActions);

            tableHeader.appendChild(headerRow);

            persone.forEach((persona) => { // 'persona' ora include l'ID
                const row = document.createElement("tr");

                const tdId = document.createElement("td");
                tdId.textContent = persona.id || ''; // Assumi che il backend ritorni un campo 'id'
                row.appendChild(tdId);

                campi.forEach(campo => {
                    const td = document.createElement("td");
                    td.textContent = persona[campo.nome_campo] || '';
                    row.appendChild(td);
                });

                const tdActions = document.createElement("td");
                
                const editButton = document.createElement("button");
                editButton.textContent = "Modifica";
                editButton.classList.add("btn", "btn-success", "btn-sm");
                editButton.style.marginRight = "5px";
                editButton.onclick = () => editPersona(persona.id); // Passa l'ID al posto dell'indice
                tdActions.appendChild(editButton);

                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Elimina";
                deleteButton.classList.add("btn", "btn-danger", "btn-sm");
                deleteButton.onclick = () => deletePersona(persona.id); // Passa l'ID
                tdActions.appendChild(deleteButton);

                row.appendChild(tdActions);
                tableBody.appendChild(row);
            });

        } catch (error) {
            console.error("Errore durante il recupero dei contatti:", error);
            tableBody.innerHTML = `<tr><td colspan="${campi.length + 2}" class="text-danger">Errore durante il caricamento dei contatti.</td></tr>`;
        }
    }

    // Funzione per la modifica di una persona (fetch dal backend)
    async function editPersona(id) {
       // Trova la persona nell'array 'persone' locale tramite ID
       const personaToEdit = persone.find(p => p.id === id);
       if (personaToEdit) {
           nascondi(); // Passa alla vista del form
           renderForm(personaToEdit); // Passa l'oggetto persona per pre-popolare
       } else {
           alert("Contatto non trovato per la modifica.");
       }
    }
    
    // Funzione per l'eliminazione di una persona (fetch dal backend)
    async function deletePersona(id) {
        const personaToDelete = persone.find(p => p.id === id);
        if (!personaToDelete) {
            alert("Contatto non trovato per l'eliminazione.");
            return;
        }

        if (confirm(`Sei sicuro di voler eliminare il contatto ${personaToDelete.nome || ''} ${personaToDelete.cognome || ''} (ID: ${id})?`)) {
            try {
                const response = await fetch(`${BASE_URL}/eliminaById/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Errore HTTP! Status: ${response.status}`);
                }

                alert("Contatto eliminato con successo!");
                await mostraElenco(); // Ricarica l'elenco dopo l'eliminazione
            } catch (error) {
                console.error("Errore durante l'eliminazione:", error);
                alert("Si è verificato un errore durante l'eliminazione del contatto: " + error.message);
            }
        }
    }


    // Funzione per eliminare tutti i contatti (richiede un endpoint nel backend)
    // ATTENZIONE: Il tuo backend NON ha un endpoint deleteAll()
    // Questa funzione NON funzionerà finché non aggiungi un @DeleteMapping("/deleteAll") nel tuo controller.
    async function deleteAll(){
        // Esempio di come sarebbe se avessi l'endpoint:
        
        if(confirm("Sei sicuro di voler eliminare tutti i contatti? Questa azione è irreversibile!")){
            try {
                const response = await fetch(`${BASE_URL}/eliminaTutti`, { // ASSUMENDO che tu abbia un endpoint /deleteAll nel backend
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Errore HTTP! Status: ${response.status}`);
                }

                alert("Tutti i contatti sono stati eliminati!");
                await mostraElenco();
            } catch (error) {
                console.error("Errore durante l'eliminazione di tutti i contatti:", error);
                alert("Si è verificato un errore durante l'eliminazione di tutti i contatti: " + error.message);
            }
        }
        
    }

    // Inizializza mostrando l'elenco al caricamento della pagina
    document.addEventListener("DOMContentLoaded", async () => {
        await mostraElenco();
    });

    // Funzione per mostrare i risultati della ricerca
    function mostraRisultatiRicerca(risultati) {
        let risultatoRicercaDiv = document.getElementById("risultatoRicerca");
      
        risultatoRicercaDiv.innerHTML = '';
        risultatoRicercaDiv.style.display = "block";

        if (risultati.length === 0) {
            risultatoRicercaDiv.innerHTML = `<div class="alert alert-info" role="alert">Nessun contatto trovato con i criteri di ricerca specificati.</div>`;
        } else {
            const table = document.createElement("table");
            table.classList.add("table", "table-striped", "table-bordered", "mt-3");
            
            const thead = document.createElement("thead");
            const tbody = document.createElement("tbody");
            const headerRow = document.createElement("tr");

            // Aggiungi colonna ID per la ricerca
            let thId = document.createElement("th");
            thId.textContent = "ID";
            headerRow.appendChild(thId);

            campi.forEach((campo) => {
                const th = document.createElement("th");
                th.textContent = campo.label;
                headerRow.appendChild(th);
            })
            thead.appendChild(headerRow);
            table.appendChild(thead);

            risultati.forEach((persona) => {
                const row = document.createElement("tr");

                const tdId = document.createElement("td");
                tdId.textContent = persona.id || '';
                row.appendChild(tdId);

                campi.forEach((campo) => {
                    const td = document.createElement("td");
                    td.textContent = persona[campo.nome_campo] || '';
                    row.appendChild(td);
                })
                tbody.appendChild(row);
            })
            table.appendChild(tbody);
            risultatoRicercaDiv.appendChild(table);
        }
           
        const RitornoARicercaBtn = document.createElement("button");
        RitornoARicercaBtn.textContent = "Torna alla ricerca";
        RitornoARicercaBtn.classList.add("btn","btn-warning","mb-3");
        RitornoARicercaBtn.style.marginRight="5px";
        RitornoARicercaBtn.addEventListener("click",() => {
            risultatoRicercaDiv.style.display = "none";
            ricercaDiv.style.display = "block";
        });
        risultatoRicercaDiv.appendChild(RitornoARicercaBtn);

        const RitornoAdElencoBtn = document.createElement("button");
        RitornoAdElencoBtn.textContent = "Torna all'elenco";
        RitornoAdElencoBtn.classList.add("btn","btn-danger","mb-3");
        RitornoAdElencoBtn.addEventListener("click",mostraElenco);
        risultatoRicercaDiv.appendChild(RitornoAdElencoBtn);
    }
</script>
</html>